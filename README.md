# duwallet

å‰²å‹˜è¨ˆç®—æ©Ÿèƒ½ã‚’å‚™ãˆãŸå…±é€šå®¶è¨ˆç°¿ Web ã‚¢ãƒ—ãƒªï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ PWAï¼‰

---

## 1. ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆæ¦‚è¦

`duwallet` ã¯è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…±åŒã§ç®¡ç†ã™ã‚‹å®¶è¨ˆç°¿ã‚’ã€åå…¥å‰²åˆã‚„æ®‹é‡‘ã«å¿œã˜ãŸç‹¬è‡ªãƒ­ã‚¸ãƒƒã‚¯ã§è‡ªå‹•å‰²å‹˜ã—ã€æ±ºæ¸ˆæœŸé™ã‚‚å«ã‚ã¦ä¸€å…ƒç®¡ç†ã§ãã‚‹ PWA ã§ã™ã€‚ä¸»ç›®çš„ã¯å¤«å©¦ 2 åã§ã®åˆ©ç”¨ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°æ‹¡å¼µã‚„ãƒãƒ¼ãƒ åˆ©ç”¨ã‚’æƒ³å®šã—ãŸã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚‚ç¢ºä¿ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªåã¯ *duet / duo* + *wallet* ã«ç”±æ¥ã—ã¾ã™ã€‚

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```mermaid
flowchart TD
  subgraph Client (Next.js PWA)
    A1[React 18 + TypeScript]
    A2[TanStack Query]
    A3[Zustand]
    A4[Service Worker]
    A1 --> A2 --> A3 --> A4
  end
  subgraph BaaS (Supabase)
    B1[PostgreSQL 15]
    B2[Auth]
    B3[Edge Functions (Deno)]
    B4[Realtime]
    B1 <--> B4
  end
  subgraph DevOps
    C1[GitHub Actions]
    C2[Vercel Hosting]
  end
  A4 --HTTPS / Supabase-js--> B2
  A4 --HTTPS / Supabase-js--> B3
  C1 --> C2
```

## 3. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆæ±ºå®šç‰ˆï¼‰

| å±¤ | æ¡ç”¨æŠ€è¡“ | ä¸»ãªå½¹å‰² | æ¡ç”¨ç†ç”± |
|----|-----------|----------|-----------|
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | **Next.js 14 (App Router)**, **React 18**, **TypeScript** | SPA/PWA | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° + SSG/ISRã€Vercel ã¨ã®ç›¸æ€§ |
| UI / ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° | **Tailwind CSS 3**, **shadcn/ui**, **class-variance-authority** | ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ  | æœ€å° CSSã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§ |
| çŠ¶æ…‹ç®¡ç† | **TanStack Query**, **Zustand** | API ã‚­ãƒ£ãƒƒã‚·ãƒ¥ / UI çŠ¶æ…‹ | ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æœ€é©åŒ–ã¨ã‚·ãƒ³ãƒ—ãƒ«ãªã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | **React Hook Form + Zod** | ãƒ•ã‚©ãƒ¼ãƒ  & å‹å®‰å…¨ | å‹å®šç¾©ã¨ã‚¹ã‚­ãƒ¼ãƒã‚’å…±æœ‰ |
| æ—¥ä»˜æ“ä½œ | **date-fns** | ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºå¯¾å¿œ | è»½é‡ã€tree-shakable |
| å›½éš›åŒ– | **i18next** | å¤šè¨€èªåŒ– | ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å®Ÿç¸¾è±Šå¯Œ |
| PWA | **next-pwa** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ | è¨­å®šãŒç°¡æ˜“ã§ iOS å¯¾å¿œå®Ÿç¸¾ã‚ã‚Š |
| èªè¨¼ / ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | **Supabase (PostgreSQL + Auth + Storage + Realtime)** | BaaS | ç„¡æ–™æ ãŒåºƒãã€RLS ã«ã‚ˆã‚‹é«˜ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ |
| ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ | **Supabase Edge Functions (TypeScript)** | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ | ç„¡æ–™ãƒ»Deno å®Ÿè¡Œç’°å¢ƒã€ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· |
| CI / CD | **GitHub Actions**, **Vercel**, **Supabase CLI** | ãƒ†ã‚¹ãƒˆï¼è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ | OSS ã‹ã¤ç„¡æ–™æ ã§å®Œçµ |
| ãƒ†ã‚¹ãƒˆ | **Jest**, **@testing-library/react**, **Playwright** | å˜ä½“ï¼çµåˆï¼E2E | PWA ã‚·ãƒŠãƒªã‚ªã‚‚ç¶²ç¾… |
| å“è³ªãƒ„ãƒ¼ãƒ« | **ESLint**, **Prettier**, **Husky**, **lint-staged**, **commitlint** | ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ | DX å‘ä¸Š |
| é–‹ç™ºç’°å¢ƒ | **Docker Compose** | ãƒ­ãƒ¼ã‚«ãƒ« DB & Edge Functions | Windows ã§ã‚‚ç’°å¢ƒå·®åˆ†ç„¡ã— |

> ğŸ’° **ã‚³ã‚¹ãƒˆè©¦ç®—**: ãƒ•ãƒ­ãƒ³ãƒˆ (Vercel Hobby)ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Supabase Free) ã§æœˆé¡ $0 é‹ç”¨ãŒå¯èƒ½ã€‚

## 4. éæ©Ÿèƒ½è¦ä»¶

| åˆ†é¡ | æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|------|--------|
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | LCP | â‰¤ 2.5 s (3G å›ç·š) |
| ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | API å¾€å¾© | â‰¤ 150 ms (99 ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«) |
| ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿æŒæœŸé–“ | 12 ãƒ¶æœˆåˆ†ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | RLS é©ç”¨ç‡ | 100 % |
| ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ | WCAG | 2.1 AA æº–æ‹  |
| å¯ç”¨æ€§ | ãƒ•ãƒ­ãƒ³ãƒˆ SLA | 99.9 % (Vercel) |
| ä¿å®ˆæ€§ | API ã‚«ãƒãƒ¬ãƒƒã‚¸ | å˜ä½“ãƒ†ã‚¹ãƒˆ 90 % + E2E 30 % |

## 5. è¾›å£ãƒ¬ãƒ“ãƒ¥ãƒ¼ & æ·»å‰Šãƒã‚¤ãƒ³ãƒˆï¼ˆæ—§åŸºæœ¬è¨­è¨ˆã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰

1. **ç”»é¢ ID ãŒæœªä»˜ä¸**
   - è¿½è·¡ãƒ»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆæ™‚ã«å‚ç…§ãŒå›°é›£ã€‚â†’ å…¨ç”»é¢ã« `A-xx` å½¢å¼ã® ID ã‚’ä»˜ä¸ã€‚
2. **å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶ã®æ¬ è½**
   - ãƒ•ãƒ­ãƒ³ãƒˆï¼DB åŒæ–¹ã§ã‚¹ã‚­ãƒ¼ãƒãŒæ›–æ˜§ã€‚â†’ Zod ã‚¹ã‚­ãƒ¼ãƒã‚’å˜ä¸€ã‚½ãƒ¼ã‚¹åŒ–ã€‚
3. **ã‚¨ãƒ©ãƒ¼ UX ã®ä¸åœ¨**
   - å¤±æ•—æ™‚ãƒ•ãƒ­ãƒ¼ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã€‚â†’ ãƒˆãƒ¼ã‚¹ãƒˆ + ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ˜ç¤ºã€‚
4. **ç”¨èªã®ä¸çµ±ä¸€**
   - ã€Œå‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã€Œãƒ¡ãƒ³ãƒãƒ¼ã€ãŒæ··åœ¨ã€‚â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³èªå½™ã‚’ README ã§çµ±ä¸€ã€‚
5. **éæ©Ÿèƒ½è¦ä»¶ãŒã‚¼ãƒ­**
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŒ‡æ¨™ãŒæœªå®šç¾©ã€‚â†’ [éæ©Ÿèƒ½è¦ä»¶] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ–°è¨­ã€‚
6. **æ¨©é™ç®¡ç†ãŒç²—ã„**
   - RLS æ–¹é‡ã‚„ãƒ­ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®è©³ç´°ãŒä¸è¶³ã€‚â†’ DB è¨­è¨ˆ YAML ã§è©³ç´°ç®¡ç†ã€‚
7. **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ & ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚è€ƒæ…®ç„¡ã—**
   - PWA ã§ã‚ã‚‹ãªã‚‰å¿…é ˆã€‚â†’ SW ã«ã‚ˆã‚‹ IndexedDB ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­è¨ˆã€‚
8. **æœˆé·ç§»ãƒ­ã‚¸ãƒƒã‚¯ãŒ UI å´ã«åŸ‹ã‚è¾¼ã¿äºˆå®š**
   - ã‚µãƒ¼ãƒãƒ¼å´ã§æœˆç· ã‚å‡¦ç†ã‚’é–¢æ•°åŒ–ã—ã€ãƒãƒƒãƒ or Edge Function Cron ã§å®Ÿè¡Œã™ã‚‹ã¹ãã€‚
9. **é€šè²¨ãƒ»ç«¯æ•°å‡¦ç†å®šç¾©ãŒæ›–æ˜§**
   - `Intl.NumberFormat` ã¨ DB å´ numeric(12,2) ã§çµ±ä¸€ã€‚åˆ‡ä¸Šã’æ¡ã‚’ config ã«ã™ã‚‹ã€‚
10. **ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ãŒç„¡ã„**
    - é–‹ç™ºè€…ä»¥å¤–ã®ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ãŒå‹•ä½œã‚’æŠŠæ¡ã—ã¥ã‚‰ã„ã€‚â†’ docs/specs é…ä¸‹ã« UML ã‚’è¿½åŠ ã€‚

## 6. åŸºæœ¬è¨­è¨ˆï¼ˆæ”¹è¨‚ç‰ˆï¼‰

ä»¥ä¸‹ã¯ä¸Šè¨˜ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åæ˜ ã—ãŸæ–°ç‰ˆã§ã™ã€‚è¡¨å½¢å¼ã§å…¨é …ç›®ã‚’æ¼ã‚Œãªãè¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

### 6.1 ç”»é¢ä¸€è¦§

| ID | ç”»é¢å | URL | ä¸»æ©Ÿèƒ½ | æ¨©é™ | å‚™è€ƒ |
|----|--------|-----|--------|------|------|
| A-01 | ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ | / | ãƒ­ã‚´è¡¨ç¤ºã€èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ | å…¨å“¡ | 3 ç§’è¡¨ç¤ºå¾Œã€è‡ªå‹•é·ç§» |
| A-02 | ãƒ­ã‚°ã‚¤ãƒ³ | /login | Email+PWã€Biometric | æœªèªè¨¼ | Supabase OTP å¯¾å¿œ |
| A-03 | æ–°è¦ç™»éŒ² | /signup | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² | æœªèªè¨¼ | æ‹›å¾…ã‚³ãƒ¼ãƒ‰å…¥åŠ›å¯ |
| B-01 | å®¶è¨ˆç°¿é¸æŠ | /books | å®¶è¨ˆç°¿åä¸€è¦§å–å¾— | èªè¨¼ | å‚åŠ  0 ä»¶ãªã‚‰ä½œæˆèª˜å° |
| B-02 | å®¶è¨ˆç°¿ä½œæˆ | /books/new | å®¶è¨ˆç°¿ç™»éŒ² | èªè¨¼ | å‚åŠ ã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆ |
| C-01 | ãƒ›ãƒ¼ãƒ  | /books/:bookId | æœˆæ¬¡ã‚µãƒãƒª | å‚åŠ è€… | æœˆé·ç§» UIã€Skeleton |
| C-02 | æœˆæ¬¡åæ”¯ç™»éŒ² | /books/:bookId/entries | åæ”¯ CRUD | å‚åŠ è€… | RHF + Zod |
| C-03 | æ”¯æ‰•å…ˆç™»éŒ² | /books/:bookId/payees | æ”¯æ‰•å…ˆ CRUD | ç®¡ç†è€… |   |
| C-04 | ç®—å‡ºè¨­å®š | /books/:bookId/settings/calc | æ”¯æ‰•é¡ãƒ­ã‚¸ãƒƒã‚¯ | ç®¡ç†è€… | å‹•çš„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
| C-05 | åŸºæœ¬è¨­å®š | /books/:bookId/settings/basic | åç§°ãƒ»å‚åŠ ã‚³ãƒ¼ãƒ‰ | ç®¡ç†è€… |   |
| C-06 | å‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | /books/:bookId/users | ãƒ­ãƒ¼ãƒ«ç®¡ç† | ç®¡ç†è€… | RLS è¶Šæ¨©ä¸å¯ |
| D-01 | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š | /me | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† | èªè¨¼ |   |

### 6.2 ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆæŠœç²‹ï¼‰

```mermaid
classDiagram
  class User {
    uuid id PK
    text email
    text name
    enum gender {male,female,other}
    bool multi_book
  }
  class Book {
    uuid id PK
    text name
    text invite_code
    bool receive_request
  }
  class BookUser {
    uuid user_id FK
    uuid book_id FK
    enum role {admin,member}
    bool approved
  }
  User "1" -- "*" BookUser
  Book "1" -- "*" BookUser
```

> DB è©³ç´°ã¯ `docs/specs/database_schema.yaml` ã‚’å‚ç…§ã€‚

### 6.3 ä¸»è¦ãƒ­ã‚¸ãƒƒã‚¯

1. **åå…¥å‰²åˆæ–¹å¼**  
   `payable = total_due * (user_income / (total_income - shared_income))`
2. **æ®‹é‡‘å‡ä¸€æ–¹å¼**  
   `payable = user_income - ((total_income - total_expense) / member_count)`
3. **æ”¯æ‰•ç‡ã‚«ã‚¹ã‚¿ãƒ **  
   ãƒ™ãƒ¼ã‚¹ç‡ Â± (N-1)% ã®æ‰‹å‹•è£œæ­£ã€‚è£œæ­£åˆ†ã¯ä»–ãƒ¡ãƒ³ãƒãƒ¼ã¸ç­‰åˆ†ã§ç›¸æ®ºã€‚
4. **ç«¯æ•°å‡¦ç†**  
   `Math.ceil(value / Math.pow(10, keta)) * Math.pow(10, keta)`

### 6.4 ãƒãƒƒãƒ & ã‚¯ãƒ­ãƒ³

| å‡¦ç† | å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚° | å®Ÿè£… | å‚™è€ƒ |
|------|---------------|------|------|
| æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ç”Ÿæˆ | æœˆæœ« 23:50 (JST) | Supabase Edge Cron | ç¿Œæœˆ +1 ãƒ¶æœˆåˆ†ä½œæˆ |
| éå»æœˆãƒ­ãƒƒã‚¯ | æœˆæœ«å‡¦ç†å¾Œ | åŒä¸Š | RLS æ›´æ–°ã§æ›¸è¾¼ç¦æ­¢ |

## 7. å®Ÿè£…æ–¹é‡ï¼ˆAI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé‹ç”¨ï¼‰

1. **docs/specs** é…ä¸‹ã« YAML å½¢å¼ã§ *ä»•æ§˜ãƒ»è©³ç´°è¨­è¨ˆãƒ»ãƒ†ãƒƒã‚¯ã‚¹ã‚¿ãƒƒã‚¯ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ»DB å®šç¾©ãƒ»ãƒ†ã‚¹ãƒˆè¨ˆç”»* ã‚’åˆ†é›¢ä¿å­˜ã™ã‚‹ã€‚  
2. ã‚¿ã‚¹ã‚¯ã¯ **docs/tasks/pending** ã«ç²’åº¦æœ€å°ã§é…ç½®ã—ã€å®Œäº†å¾Œ **docs/tasks/done** ã¸ç§»å‹•ã€‚  
3. ä¾å­˜é–¢ä¿‚ã¯ `task_manager.yaml` ã§ DAG ç®¡ç†ã—ã€ç›´åˆ—ï¼ä¸¦åˆ—ã‚’æ˜ç¤ºã€‚  
4. å„ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã« AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å¿…ãšä¸Šè¨˜ YAML ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€çŸ›ç›¾ãŒç„¡ã„ã‹æ¤œè¨¼ã™ã‚‹ã€‚  
5. ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¾Œã¯ **CI (GitHub Actions)** ã§ `pnpm test && playwright test --reporter=line` ã‚’é€šéã™ã‚‹ã¾ã§ã¯å®Œäº†ã¨ã—ãªã„ã€‚  
6. **çœç•¥ç¦æ­¢ / ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚¼ãƒ­** ã‚’éµå®ˆã—ã€å¤‰æ›´å·®åˆ†ã¯æ˜ç¤ºçš„ã« Pull Request ã§å…±æœ‰ã™ã‚‹ã€‚

---

> æœ¬ README ã¯ 2024-06-XX ã«å…¨é¢æ”¹è¨‚ã•ã‚Œã¾ã—ãŸã€‚ä»¥å‰ã®å†…å®¹ã¯ Git å±¥æ­´ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
