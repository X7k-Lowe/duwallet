# 開発環境構築手順 (duwallet)

このドキュメントでは、**ローカル開発環境**を最短で立ち上げる手順を説明します。

---

## 1. 前提ソフトウェア

| ツール         | 推奨バージョン      | 備考                                                           |
| -------------- | ------------------- | -------------------------------------------------------------- |
| Git            | 2.40 以上           | GitHub との連携に使用                                          |
| Node.js        | 18 LTS              | Next.js 14 推奨環境。`nvm` 等で切替可                        |
| pnpm           | 8.15.4              | `corepack enable && corepack prepare pnpm@latest --activate` |
| Docker Desktop | 4.27+ (Engine 24.x) | Compose v2 同梱                                                |

> ✨ **M1/M2 Mac** の場合は Rosetta 2 を有効化したうえで Docker の Apple Silicon 版をインストールしてください。

---

## 1-A. Windows (WSL2 なし) 環境セットアップ

1. **Node.js** : [https://nodejs.org/ja](https://nodejs.org/ja) から 18LTS MSI をインストール。
2. **pnpm** : PowerShell を管理者として実行し
   ```powershell
   corepack enable; corepack prepare pnpm@latest --activate
   ```
3. **Git** : Git for Windows (2.42+) をインストール。
4. **Docker Desktop** : Windows 版をインストールし、設定 > 使用リソース で CPU 4 / メモリ 4GB 以上を割当。
5. コマンドは **PowerShell** でも **Git Bash** でも可。

> ⚠️ Windows Home で Hyper-V が無効な場合は WSL2 backend を選択してください。

---

## 2. リポジトリの取得

```bash
# 任意の作業ディレクトリで
git clone https://github.com/<your-account>/duwallet.git
cd duwallet
```

> 本リポジトリはコードではなく設計資料のみを保持します。実装用リポジトリは別途作成予定です。

---

## 3. Supabase ローカル環境の起動 (Docker Compose)

1. Supabase CLI をインストール（Homebrew 例）
   ```bash
   brew install supabase/tap/supabase
   ```
2. 初期化 & 起動
   ```bash
   supabase init # 初回のみ
   supabase start # PostgreSQL + Studio + Edge Functions が起動
   ```
3. `.supabase` フォルダが生成され、`http://localhost:54322` で DB、`http://localhost:54322/auth/v1` で Auth エンドポイントが利用可能になります。

---

## 4. アプリケーションの起動 (開発)

```bash
pnpm install      # 依存パッケージを解決
cp .env.example .env.local  # 環境変数テンプレートをコピー
# .env.local を編集し、SUPABASE_URL / SUPABASE_ANON_KEY などを入力

pnpm dev          # http://localhost:3000 で起動
```

### Docker 経由での起動 (推奨)

アプリと Supabase をまとめて起動したい場合は `docker-compose.dev.yml` を用意しています。

```bash
docker compose -f docker-compose.dev.yaml up -d --build
```

* Next.js = [http://localhost:3000](http://localhost:3000)
* Supabase/PostgreSQL = [http://localhost:54322](http://localhost:54322)

---

#### 【補足】Supabase CLIで起動する場合

Supabase CLI (`supabase start`) で起動した場合は `http://localhost:54323` となります。

---

## 4-B. Docker Compose で一括起動 (Windows/Mac 共通)

```powershell
# .env ファイルに Supabase 関連キーを設定後
# 初回のみイメージビルド
docker compose -f docker-compose.dev.yaml build
# バックグラウンド起動
docker compose -f docker-compose.dev.yaml up -d
```

* アプリ : [http://localhost:3000](http://localhost:3000)
* PostgreSQL (Supabase) : `localhost:54322` (ユーザ/パスワード: supabase)

停止: `docker compose -f docker-compose.dev.yaml down -v` でボリュームごと削除。

---

## 5. 便利スクリプト

| コマンド              | 説明                                            |
| --------------------- | ----------------------------------------------- |
| `pnpm lint`         | ESLint + Prettier チェック                      |
| `pnpm test`         | Vitest 実行                                     |
| `pnpm typecheck`    | TypeScript 型チェックのみ                       |
| `supabase db reset` | ローカル DB をリセット & マイグレーション再実行 |

---

## 6. VSCode 拡張推奨

* **ESLint** – コード品質チェック
* **Tailwind CSS IntelliSense** – クラス補完
* **Prisma** – (将来 RLS View 等を Prisma で扱う場合)
* **Supabase** – クエリエディタ

---

## 7. よくあるトラブルシューティング

| 症状                                   | 対処                                                            |
| -------------------------------------- | --------------------------------------------------------------- |
| `next-pwa` 周りのビルドエラー        | `node_modules/.cache` を削除後 `pnpm dev` を再実行          |
| Supabase 接続エラー (`ECONNREFUSED`) | `supabase start` が動作しているか確認。ポート競合も要チェック |
| Docker 起動が重い                      | CPU/メモリ制限を Docker Desktop 設定で緩和                      |

---

これでローカル開発環境は完了です 🎉
