# 開発環境構築手順 (duwallet)

このドキュメントでは、**ローカル開発環境**を最短で立ち上げる手順を説明します。

---

## 1. 前提ソフトウェア

| ツール         | 推奨バージョン      | 備考                                                           |
| -------------- | ------------------- | -------------------------------------------------------------- |
| Git            | 2.40 以上           | GitHub との連携に使用                                          |
| Node.js        | 18 LTS              | Next.js 14 推奨環境。`nvm` 等で切替可                        |
| pnpm           | 8.15.4              | `corepack enable && corepack prepare pnpm@latest --activate` |
| Docker Desktop | 4.27+ (Engine 24.x) | Compose v2 同梱                                                |

> ✨ **M1/M2 Mac** の場合は Rosetta 2 を有効化したうえで Docker の Apple Silicon 版をインストールしてください。

---

## 1-A. Windows (WSL2 なし) 環境セットアップ

1. **Node.js** : [https://nodejs.org/ja](https://nodejs.org/ja) から 18LTS MSI をインストール。
2. **pnpm** : PowerShell を管理者として実行し
   ```powershell
   corepack enable; corepack prepare pnpm@latest --activate
   ```
3. **Git** : Git for Windows (2.42+) をインストール。
4. **Docker Desktop** : Windows 版をインストールし、設定 > 使用リソース で CPU 4 / メモリ 4GB 以上を割当。
5. コマンドは **PowerShell** でも **Git Bash** でも可。

> ⚠️ Windows Home で Hyper-V が無効な場合は WSL2 backend を選択してください。

---

## 2. リポジトリの取得

```bash
# 任意の作業ディレクトリで
git clone https://github.com/<your-account>/duwallet.git
cd duwallet
```

> 本リポジトリはコードではなく設計資料のみを保持します。実装用リポジトリは別途作成予定です。

---

## 3. Supabase プロジェクトの準備 (クラウド)

1. Supabase公式サイト ([https://supabase.com/](https://supabase.com/)) でアカウントを作成し、新しいプロジェクトを作成します。
2. プロジェクト作成後、プロジェクトの「Settings」>「API」ページから以下の情報を取得します。
   - **Project URL** (`SUPABASE_URL` として `.env.local` に設定)
   - **Project API Keys** の `anon` `public` (`NEXT_PUBLIC_SUPABASE_ANON_KEY` として `.env.local` に設定)
   - **Project API Keys** の `service_role` Secret (`SUPABASE_SERVICE_ROLE_KEY` として `.env.local` に設定)
3. 同じく「Settings」>「Auth」>「JWT Settings」から **JWT Secret** (`SUPABASE_JWT_SECRET` として `.env.local` に設定) を取得します。このシークレットは32文字以上である必要があります。

これらのキーを `.env.local` ファイルに設定してください。詳細は `Secrets_Env_Guide.md` を参照してください。

---

## 4. アプリケーションの起動 (開発)

```bash
pnpm install      # 依存パッケージを解決
cp .env.example .env.local  # 環境変数テンプレートをコピー
# .env.local を編集し、SUPABASE_URL / SUPABASE_ANON_KEY などを入力

pnpm dev          # http://localhost:3000 で起動
```

### Docker 経由での起動 (推奨)

Next.jsアプリケーションをDockerコンテナで起動します。事前に `.env.local` にクラウドSupabaseの接続情報が設定されていることを確認してください。

```bash
docker compose -f docker-compose.dev.yaml up --build
```

* Next.js = [http://localhost:3000](http://localhost:3000)

---

#### 【補足】Supabase CLIで起動する場合

Supabase CLI (`supabase start`) で起動した場合は `http://localhost:54323` となります。

---

## 4-B. Docker Compose で一括起動 (Windows/Mac 共通)

```powershell
# .env.local ファイルにクラウドSupabaseの関連キーを設定後
# 初回のみイメージビルド
docker compose -f docker-compose.dev.yaml build
# バックグラウンド起動
docker compose -f docker-compose.dev.yaml up -d
```

* アプリ : [http://localhost:3000](http://localhost:3000)

停止: `docker compose -f docker-compose.dev.yaml down`

---

## 5. 便利スクリプト

| コマンド              | 説明                                            |
| --------------------- | ----------------------------------------------- |
| `pnpm lint`         | ESLint + Prettier チェック                      |
| `pnpm test`         | Vitest 実行                                     |
| `pnpm typecheck`    | TypeScript 型チェックのみ                       |
| `supabase db reset` | ローカル DB をリセット & マイグレーション再実行 |

---

## 6. VSCode 拡張推奨

* **ESLint** – コード品質チェック
* **Tailwind CSS IntelliSense** – クラス補完
* **Prisma** – (将来 RLS View 等を Prisma で扱う場合)
* **Supabase** – クエリエディタ

---

## 7. よくあるトラブルシューティング

| 症状                                   | 対処                                                            |
| -------------------------------------- | --------------------------------------------------------------- |
| `next-pwa` 周りのビルドエラー        | `node_modules/.cache` を削除後 `pnpm dev` を再実行          |
| Supabase 接続エラー (`ECONNREFUSED`) | `.env.local` の `NEXT_PUBLIC_SUPABASE_URL` や各キーが正しく設定されているか確認。クラウドSupabaseプロジェクトのステータスも確認。 |
| Docker 起動が重い                      | CPU/メモリ制限を Docker Desktop 設定で緩和                      |

---

これでローカル開発環境は完了です 🎉
