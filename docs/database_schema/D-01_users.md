# D-01: users テーブル定義

このドキュメントでは、ユーザー認証とユーザーのプロフィール情報を管理するテーブルについて定義します。Supabaseの認証機能 (`auth.users`) と連携し、アプリケーション固有のユーザー情報を `public.users` テーブルで管理します。

## 1. `auth.users` テーブル (Supabase標準)

Supabaseによる認証機能を有効にすると自動的に作成されるテーブルです。ユーザーの認証情報（メールアドレス、パスワードハッシュ等）をセキュアに管理します。アプリケーションから直接変更することは推奨されず、Supabase Auth APIを通じて操作します。

| 物理名             | 論理名             | データ型     | 説明                                                                 |
|--------------------|--------------------|--------------|----------------------------------------------------------------------|
| id                 | ユーザーID (Auth)  | uuid         | 認証ユーザーの一意なID。`public.users` テーブルの主キーとして利用。    |
| email              | Eメール (Auth)     | varchar      | 認証に使用するメールアドレス。                                         |
| encrypted_password | パスワードハッシュ(Auth) | varchar      | ハッシュ化されたユーザーパスワード。                                   |
| created_at         | 作成日時 (Auth)    | timestamptz  | 認証ユーザーレコードの作成日時。                                       |
| updated_at         | 更新日時 (Auth)    | timestamptz  | 認証ユーザーレコードの最終更新日時。                                   |
| last_sign_in_at    | 最終ログイン日時(Auth) | timestamptz  | ユーザーの最終ログイン日時。                                         |
| ...                | 他多数             | ...          | 確認ステータス、MFA設定など、Supabaseが管理するその他の認証関連情報。 |

## 2. `public.users` テーブル (カスタム)

アプリケーション固有のユーザープロフィール情報や設定を管理するテーブルです。`auth.users.id` を外部キーとして参照し、認証情報とプロフィール情報を紐付けます。
ユーザーのEメールアドレスは `auth.users.email` を参照します。

### テーブル仕様

| 項目                | 値                                     |
|---------------------|------------------------------------------|
| 物理テーブル名      | users                                    |
| 論理テーブル名      | ユーザープロフィール                     |
| 主キー              | id (auth.users.id を参照)                |
| 外部キー            | id (auth.users.id への参照)              |
| 期待レコード数      | 数十〜数百                               |

### カラム定義

| 物理名              | 論理名           | データ型          | 必須  | デフォルト値      | 説明                                                                                                |
|---------------------|------------------|-------------------|-------|-------------------|-----------------------------------------------------------------------------------------------------|
| id                  | ユーザーID       | uuid              | Yes   | なし              | プライマリキー。Supabaseの `auth.users.id` を参照する外部キー。                                       |
| name                | 名前              | varchar(100)      | Yes   | なし              | ユーザー表示名                                                                                      |
| gender              | 性別              | varchar(10)       | No    | null              | 性別（male/female/other）                                                                            |
| multiple_wallets    | 複数家計簿参加設定 | boolean          | Yes   | false             | 複数家計簿に参加するか（true）、一つのみか（false）                                                              |
| created_at          | 作成日時          | timestamptz       | Yes   | CURRENT_TIMESTAMP | レコード作成日時。`auth.users.created_at` とは別に、このプロファイルレコード自体の作成日時。        |
| updated_at          | 更新日時          | timestamptz       | Yes   | CURRENT_TIMESTAMP | レコード更新日時。                                                                                  |

### インデックス

| インデックス名      | カラム            | 種類              | 説明                                                              |
|---------------------|-------------------|-------------------|-------------------------------------------------------------------|
| users_pkey          | id                | PRIMARY KEY       | プライマリキー                                                    |

### 制約

- `id` は `auth.users` テーブルに存在する `id` を参照すること。
- Eメールアドレスに関する操作 (新規登録時の設定、変更など) は `supabase.auth` API を通じて `auth.users` テーブルに対して行い、`public.users` にはEメール情報を保持しません。アプリケーションからは `auth.users.email` を参照してください。

### 関連テーブル

- wallet_members: ユーザーと家計簿の関連を管理
- wallet_join_requests: ユーザーの家計簿参加申請を管理

### 備考
- ユーザーが新規登録 (Supabase Authの`signUp`) されると、`auth.users` にレコードが作成されます。その後、この `public.users` テーブルにも対応するレコードが作成されるように、データベーストリガーまたはアプリケーション側のロジックで処理を実装する必要があります。Eメールアドレスは `auth.users` に格納されているため、`public.users` には不要です。
- ユーザーがメールアドレスを変更する場合 (例: `S-11_user_settings.yaml`経由)、Supabase Auth API (`supabase.auth.updateUser({ email: newEmail })`) を使用して `auth.users.email` を更新します。`public.users` にはEメールカラムが存在しないため、同期は不要です。
