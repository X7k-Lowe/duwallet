# DUWALLET - å…±åŒå®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª

è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…±åŒã§ç®¡ç†ã™ã‚‹å®¶è¨ˆç°¿ã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ä¸­å¿ƒã«åˆ©ç”¨ã™ã‚‹PWAã§ã™ã€‚åå…¥å‰²åˆæ–¹å¼ã¾ãŸã¯æ®‹é‡‘å‡ä¸€æ–¹å¼ã§æœˆæ¬¡æ”¯æ‰•é¡ã‚’è‡ªå‹•ç®—å‡ºã—ã€æ”¯æ‰•å…ˆãƒ»æ”¯æ‰•æœŸé™ã‚‚å«ã‚ã¦å¯è¦–åŒ–ã—ã¾ã™ã€‚

## ç’°å¢ƒæ§‹ç¯‰

### è¦ä»¶

- Node.js >=18.0.0
- pnpm >=8.0.0
- Docker Compose >=2.0

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/yourusername/duwallet.git
cd duwallet

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pnpm
pnpm install

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
cp .env.example .env

# Supabaseãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®èµ·å‹•
docker compose up -d supabase
```

### é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

```bash
pnpm dev
```

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ [http://localhost:3000](http://localhost:3000) ã§åˆ©ç”¨ã§ãã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
pnpm test

# E2Eãƒ†ã‚¹ãƒˆ
pnpm playwright test --reporter=line
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

- `/apps/web` - Next.js 14ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (App Router)
- `/packages/ui` - å…±æœ‰UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- `/supabase` - Supabaseé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ« (ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€Edge Functions)
- `/docs` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: Next.js 14, TypeScript 5, TailwindCSS, shadcn/ui
- çŠ¶æ…‹ç®¡ç†: Zustand, TanStack Query
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: Supabase@^1.0 (PostgreSQL 15, Auth, Storage)
- ãƒ†ã‚¹ãƒˆ: Jest, React Testing Library, Playwright

## 1. ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆæ¦‚è¦

`duwallet` ã¯è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…±åŒã§ç®¡ç†ã™ã‚‹å®¶è¨ˆç°¿ã‚’ã€åå…¥å‰²åˆã‚„æ®‹é‡‘ã«å¿œã˜ãŸç‹¬è‡ªãƒ­ã‚¸ãƒƒã‚¯ã§è‡ªå‹•å‰²å‹˜ã—ã€æ±ºæ¸ˆæœŸé™ã‚‚å«ã‚ã¦ä¸€å…ƒç®¡ç†ã§ãã‚‹ PWA ã§ã™ã€‚ä¸»ç›®çš„ã¯å¤«å©¦ 2 åã§ã®åˆ©ç”¨ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°æ‹¡å¼µã‚„ãƒãƒ¼ãƒ åˆ©ç”¨ã‚’æƒ³å®šã—ãŸã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚‚ç¢ºä¿ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªåã¯ _duet / duo_ + _wallet_ ã«ç”±æ¥ã—ã¾ã™ã€‚

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```mermaid
graph TD
  %% === Client Side ===
  A1[Next.js 14 / React 18]
  A2[TanStack Query]
  A3[Zustand]
  A1 --> A2 --> A3

  %% === Supabase ===
  B1[PostgreSQL 15]
  B2[Auth]
  B3[Edge Functions]
  B4[Realtime]
  B1 --> B2
  B1 --> B3
  B1 --> B4

  %% === DevOps ===
  C1[GitHub Actions]
  C2[Vercel]
  C1 --> C2

  %% === Connections ===
  A3 --> B2
  A3 --> B3
```

## 3. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆæ±ºå®šç‰ˆï¼‰

| å±¤                   | æ¡ç”¨æŠ€è¡“                                                                | ä¸»ãªå½¹å‰²                     | æ¡ç”¨ç†ç”±                                         |
| -------------------- | ----------------------------------------------------------------------- | ---------------------------- | ------------------------------------------------ |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰       | **Next.js 14 (App Router)**, **React 18**, **TypeScript 5**             | SPA/PWA                      | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° + SSG/ISRã€Vercel ã¨ã®ç›¸æ€§  |
| UI / ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°    | **Tailwind CSS 3**, **shadcn/ui**, **class-variance-authority ^0.7.1**  | ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ              | æœ€å° CSSã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§         |
|                      | **clsx ^2.0.0**, **tailwind-merge ^2.1.0**, **tailwindcss-animate**     | ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£               | ã‚¯ãƒ©ã‚¹çµåˆãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³                       |
|                      | **lucide-react ^0.507.0**, **radix-ui/react-components**                | ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«UI     | ãƒ¢ãƒ€ãƒ³ã§ä¸€è²«ã—ãŸUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ                 |
| çŠ¶æ…‹ç®¡ç†             | **TanStack Query ^5.13.4**, **Zustand ^4.4.7**                          | API ã‚­ãƒ£ãƒƒã‚·ãƒ¥ / UI çŠ¶æ…‹     | ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æœ€é©åŒ–ã¨ã‚·ãƒ³ãƒ—ãƒ«ãªã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³       | **React Hook Form ^7.56.2** + **Zod ^3.24.4**                           | ãƒ•ã‚©ãƒ¼ãƒ  & å‹å®‰å…¨            | å‹å®šç¾©ã¨ã‚¹ã‚­ãƒ¼ãƒã‚’å…±æœ‰                           |
|                      | **@hookform/resolvers ^5.0.1**                                          | ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼                 | ãƒ•ã‚©ãƒ¼ãƒ ã¨Zodã®é€£æº                              |
| æ—¥ä»˜æ“ä½œ             | **date-fns ^2.30.0**                                                    | ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºå¯¾å¿œ             | è»½é‡ã€tree-shakable                              |
| é€šè²¨/å˜ä½            | **Intl.NumberFormat (Â¥)**                                               | é‡‘é¡è¡¨ç¤º                     | æ—¥æœ¬å††å°‚ç”¨ã§å®Ÿè£…                                 |
| å›½éš›åŒ–               | **ãªã—** (æ—¥æœ¬èªå›ºå®š)                                                   | è¨€èªå¯¾å¿œ                     | å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥æœ¬äººã®ã¿ã®ãŸã‚                   |
| PWA                  | **next-pwa ^5.6.0** (Workbox)                                           | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³   | è¨­å®šãŒç°¡æ˜“ã§ iOS å¯¾å¿œå®Ÿç¸¾ã‚ã‚Š                    |
| èªè¨¼ / ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹  | **Supabase@^1.0** (PostgreSQL 15 + Auth + Storage + Realtime)           | BaaS                         | ç„¡æ–™æ ãŒåºƒãã€RLS ã«ã‚ˆã‚‹é«˜ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£         |
| Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | **supabase-js ^2.39.0**, **auth-helpers-nextjs ^0.8.7**, **ssr ^0.6.1** | APIã‚¢ã‚¯ã‚»ã‚¹                  | Supabaseå…¬å¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                         |
| èªè¨¼æ–¹å¼             | **Supabase Auth** (Email, OTP, OAuth)                                   | ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼                 | è¤‡æ•°èªè¨¼æ–¹å¼ã®çµ±åˆç®¡ç†ãŒå®¹æ˜“                     |
| ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯     | **Supabase Edge Functions** (Deno + TypeScript)                         | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯             | ç„¡æ–™ãƒ»Deno å®Ÿè¡Œç’°å¢ƒã€ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·                |
| CI / CD              | **GitHub Actions**, **Vercel**, **Supabase CLI**                        | ãƒ†ã‚¹ãƒˆï¼è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤         | OSS ã‹ã¤ç„¡æ–™æ ã§å®Œçµ                             |
| ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°         | **Vercel Hobby Plan**                                                   | ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ                   | ç„¡æ–™æ ã€CI/CDçµ±åˆã€é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹              |
| ãƒ†ã‚¹ãƒˆ               | **Jest ^29.7.0**, **@testing-library/react ^14.1.2**                    | å˜ä½“ï¼çµåˆ                   | Reactå‘ã‘æ¨™æº–ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª                    |
|                      | **Playwright ^1.52.0** (chromium, webkit, firefox)                      | E2E                          | PWA ã‚·ãƒŠãƒªã‚ªã‚‚ç¶²ç¾…                               |
| å“è³ªãƒ„ãƒ¼ãƒ«           | **ESLint ^8.55.0**, **Prettier ^3.5.3**                                 | ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€           | DX å‘ä¸Š                                          |
|                      | **Husky ^8.0.3**, **lint-staged ^15.2.0**, **commitlint ^18.4.3**       | Git ãƒ•ãƒƒã‚¯                   | ã‚³ãƒŸãƒƒãƒˆå‰å“è³ªç¢ºä¿                               |
| é–‹ç™ºç’°å¢ƒ             | **Docker Compose >=2.0**                                                | ãƒ­ãƒ¼ã‚«ãƒ« DB & Edge Functions | Windows ã§ã‚‚ç’°å¢ƒå·®åˆ†ç„¡ã—                         |
| ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ         | **pnpm workspaces**                                                     | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†               | è¤‡æ•°ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åŠ¹ç‡çš„ç®¡ç†                       |

> ğŸ’° **ã‚³ã‚¹ãƒˆè©¦ç®—**: ãƒ•ãƒ­ãƒ³ãƒˆ (Vercel Hobby)ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Supabase Free) ã§æœˆé¡ $0 é‹ç”¨ãŒå¯èƒ½ã€‚

## 4. éæ©Ÿèƒ½è¦ä»¶

| åˆ†é¡             | æŒ‡æ¨™               | ç›®æ¨™å€¤                       |
| ---------------- | ------------------ | ---------------------------- |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹   | LCP                | â‰¤ 2.5 s (3G å›ç·š)            |
| ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·       | API å¾€å¾©           | â‰¤ 150 ms (99 ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«) |
| ã‚ªãƒ•ãƒ©ã‚¤ãƒ³       | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿æŒæœŸé–“ | 12 ãƒ¶æœˆåˆ†ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³  |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£     | RLS é©ç”¨ç‡         | 100 %                        |
| ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ | WCAG               | 2.1 AA æº–æ‹                   |
| å¯ç”¨æ€§           | ãƒ•ãƒ­ãƒ³ãƒˆ SLA       | 99.9 % (Vercel)              |
| ä¿å®ˆæ€§           | API ã‚«ãƒãƒ¬ãƒƒã‚¸     | å˜ä½“ãƒ†ã‚¹ãƒˆ 90 % + E2E 30 %   |

## 5. è¾›å£ãƒ¬ãƒ“ãƒ¥ãƒ¼ & æ·»å‰Šãƒã‚¤ãƒ³ãƒˆï¼ˆæ—§åŸºæœ¬è¨­è¨ˆã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰

1. **ç”»é¢ ID ãŒæœªä»˜ä¸**
   - è¿½è·¡ãƒ»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆæ™‚ã«å‚ç…§ãŒå›°é›£ã€‚â†’ å…¨ç”»é¢ã« `A-xx` å½¢å¼ã® ID ã‚’ä»˜ä¸ã€‚
2. **å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶ã®æ¬ è½**
   - ãƒ•ãƒ­ãƒ³ãƒˆï¼DB åŒæ–¹ã§ã‚¹ã‚­ãƒ¼ãƒãŒæ›–æ˜§ã€‚â†’ Zod ã‚¹ã‚­ãƒ¼ãƒã‚’å˜ä¸€ã‚½ãƒ¼ã‚¹åŒ–ã€‚
3. **ã‚¨ãƒ©ãƒ¼ UX ã®ä¸åœ¨**
   - å¤±æ•—æ™‚ãƒ•ãƒ­ãƒ¼ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã€‚â†’ ãƒˆãƒ¼ã‚¹ãƒˆ + ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ˜ç¤ºã€‚
4. **ç”¨èªã®ä¸çµ±ä¸€**
   - ã€Œå‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã€Œãƒ¡ãƒ³ãƒãƒ¼ã€ãŒæ··åœ¨ã€‚â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³èªå½™ã‚’ README ã§çµ±ä¸€ã€‚
5. **éæ©Ÿèƒ½è¦ä»¶ãŒã‚¼ãƒ­**
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŒ‡æ¨™ãŒæœªå®šç¾©ã€‚â†’ [éæ©Ÿèƒ½è¦ä»¶] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ–°è¨­ã€‚
6. **æ¨©é™ç®¡ç†ãŒç²—ã„**
   - RLS æ–¹é‡ã‚„ãƒ­ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®è©³ç´°ãŒä¸è¶³ã€‚â†’ DB è¨­è¨ˆ YAML ã§è©³ç´°ç®¡ç†ã€‚
7. **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ & ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚è€ƒæ…®ç„¡ã—**
   - PWA ã§ã‚ã‚‹ãªã‚‰å¿…é ˆã€‚â†’ SW ã«ã‚ˆã‚‹ IndexedDB ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­è¨ˆã€‚
8. **æœˆé·ç§»ãƒ­ã‚¸ãƒƒã‚¯ãŒ UI å´ã«åŸ‹ã‚è¾¼ã¿äºˆå®š**
   - ã‚µãƒ¼ãƒãƒ¼å´ã§æœˆç· ã‚å‡¦ç†ã‚’é–¢æ•°åŒ–ã—ã€ãƒãƒƒãƒ or Edge Function Cron ã§å®Ÿè¡Œã™ã‚‹ã¹ãã€‚
9. **é€šè²¨ãƒ»ç«¯æ•°å‡¦ç†å®šç¾©ãŒæ›–æ˜§**
   - `Intl.NumberFormat` ã¨ DB å´ numeric(12,2) ã§çµ±ä¸€ã€‚åˆ‡ä¸Šã’æ¡ã‚’ config ã«ã™ã‚‹ã€‚
10. **ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ãŒç„¡ã„**
    - é–‹ç™ºè€…ä»¥å¤–ã®ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ãŒå‹•ä½œã‚’æŠŠæ¡ã—ã¥ã‚‰ã„ã€‚â†’ docs/specs é…ä¸‹ã« UML ã‚’è¿½åŠ ã€‚

## 6. åŸºæœ¬è¨­è¨ˆï¼ˆæ”¹è¨‚ç‰ˆï¼‰

ä»¥ä¸‹ã¯ä¸Šè¨˜ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åæ˜ ã—ãŸæ–°ç‰ˆã§ã™ã€‚è¡¨å½¢å¼ã§å…¨é …ç›®ã‚’æ¼ã‚Œãªãè¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

### 6.1 ç”»é¢ä¸€è¦§

| ID   | ç”»é¢å                  | URL                           | ä¸»æ©Ÿèƒ½                     | æ¨©é™   | å‚™è€ƒ                                              |
| ---- | ----------------------- | ----------------------------- | -------------------------- | ------ | ------------------------------------------------- |
| A-01 | ã‚¿ã‚¤ãƒˆãƒ« / ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ | /                             | ãƒ­ã‚´è¡¨ç¤ºã€èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ | å…¨å“¡   | 3 ç§’è¡¨ç¤ºå¾Œã€è‡ªå‹•é·ç§»                              |
| A-02 | ãƒ­ã‚°ã‚¤ãƒ³                | /login                        | Email+PWã€Biometric        | æœªèªè¨¼ | Supabase OTP å¯¾å¿œ                                 |
| A-03 | æ–°è¦ç™»éŒ²                | /signup                       | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²               | æœªèªè¨¼ | ãƒ¡ãƒ¼ãƒ«ç¢ºèªã«ã‚ˆã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³                |
| B-01 | å®¶è¨ˆç°¿é¸æŠ              | /books                        | å®¶è¨ˆç°¿åä¸€è¦§å–å¾—           | èªè¨¼   | å‚åŠ ã‚³ãƒ¼ãƒ‰å…¥åŠ› (ãƒ¢ãƒ¼ãƒ€ãƒ«)ãƒ»å®¶è¨ˆç°¿ä½œæˆãƒœã‚¿ãƒ³ã‚’å«ã‚€ |
| B-02 | å®¶è¨ˆç°¿ä½œæˆ              | /books/new                    | å®¶è¨ˆç°¿ç™»éŒ²                 | èªè¨¼   | å‚åŠ ã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆï¼æ‰‹å‹•å…¥åŠ›åˆ‡æ›¿                  |
| C-01 | ãƒ›ãƒ¼ãƒ                   | /books/:bookId                | æœˆæ¬¡ã‚µãƒãƒª                 | å‚åŠ è€… | æœˆé·ç§» UIã€Skeleton                               |
| C-02 | æœˆæ¬¡åæ”¯ç™»éŒ²            | /books/:bookId/entries        | åæ”¯ CRUD                  | å‚åŠ è€… | RHF + Zodã€å¯¾è±¡æœˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³                       |
| C-03 | æ”¯æ‰•å…ˆç™»éŒ²              | /books/:bookId/payees         | æ”¯æ‰•å…ˆ CRUD                | ç®¡ç†è€… |                                                   |
| C-04 | æ”¯æ‰•é¡ç®—å‡ºè¨­å®š          | /books/:bookId/settings/calc  | æ”¯æ‰•é¡ãƒ­ã‚¸ãƒƒã‚¯             | ç®¡ç†è€… | å‹•çš„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼                                    |
| C-05 | åŸºæœ¬è¨­å®šç·¨é›†            | /books/:bookId/settings/basic | åç§°ãƒ»å‚åŠ ã‚³ãƒ¼ãƒ‰           | ç®¡ç†è€… |                                                   |
| C-06 | å‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†        | /books/:bookId/users          | ãƒ­ãƒ¼ãƒ«ç®¡ç†                 | ç®¡ç†è€… | RLS è¶Šæ¨©ä¸å¯                                      |
| D-01 | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š            | /me                           | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†           | èªè¨¼   |                                                   |

### 6.2 ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆæŠœç²‹ï¼‰

```mermaid
classDiagram
  class User {
    +uuid id
    +text email
    +text name
    +enum gender
    +bool multiBook
  }

  class Book {
    +uuid id
    +text name
    +text inviteCode
    +bool receiveRequest
  }

  class BookUser {
    +uuid userId
    +uuid bookId
    +enum role
    +bool approved
  }

  User "1" -- "*" BookUser
  Book "1" -- "*" BookUser
```

> DB è©³ç´°ã¯ `docs/specs/database_schema.yaml` ã‚’å‚ç…§ã€‚

### 6.3 ç®—å‡ºãƒ­ã‚¸ãƒƒã‚¯ & å¤‰æ•°å®šç¾©

| å¤‰æ•°           | æ„å‘³                          | å‡ºå…¸                     |
| -------------- | ----------------------------- | ------------------------ |
| `userIncome`   | å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœˆæ¬¡åå…¥åˆè¨ˆ    | æœˆæ¬¡åæ”¯ãƒ†ãƒ¼ãƒ–ãƒ« `Entry` |
| `totalIncome`  | å…¨å‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼æœˆæ¬¡åå…¥åˆè¨ˆ    | åŒä¸Š                     |
| `sharedIncome` | å…±é€šåå…¥é¡                    | åŒä¸Š                     |
| `userExpense`  | å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æœˆæ¬¡æ”¯å‡ºåˆè¨ˆ      | åŒä¸Š                     |
| `totalExpense` | å…¨å‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼æœˆæ¬¡æ”¯å‡ºåˆè¨ˆ    | åŒä¸Š                     |
| `memberCount`  | å®¶è¨ˆç°¿å‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°          | `BookUser`               |
| `totalDue`     | æœˆæ¬¡æ”¯æ‰•ç·é¡ï¼ˆæ”¯æ‰•å…ˆåˆç®—ï¼‰    | `Payee` / ç®—å‡ºè¨­å®š       |
| `roundDigit`   | åˆ‡ä¸Šã’æ¡ (10^n)               | ç®—å‡ºè¨­å®š `CalcSetting`   |
| `incomeSource` | åå…¥å‚ç…§å…ˆ (`prev` or `curr`) | è¨­å®šç”»é¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ |

1. **åå…¥å‰²åˆæ–¹å¼** `payable = totalDue * (userIncome / (totalIncome - sharedIncome))`
2. **æ®‹é‡‘å‡ä¸€æ–¹å¼** `payable = userIncome - ((totalIncome - totalExpense) / memberCount)`
3. **ãƒ™ãƒ¼ã‚¹æ”¯æ‰•ç‡ (BasePayRatio)**æ–¹å¼ 1 ã®æ¯”ç‡ã¾ãŸã¯æ–¹å¼ 2 ã‹ã‚‰å°å‡ºã—ãŸ `payable / totalDue` ã‚’åŸºæº–ã¨ã—ã€ç®¡ç†è€…ã¯ Â±(memberCount-1)% ã¾ã§è£œæ­£å¯ã€‚è£œæ­£ã•ã‚ŒãŸæ¯”ç‡ã¯ä»–ãƒ¡ãƒ³ãƒãƒ¼ã«ç­‰åˆ†ã§åæ˜ ã€‚
4. **ç«¯æ•°å‡¦ç†** `ceil(payable / roundDigit) * roundDigit`
5. **åå…¥å‚ç…§å…ˆé¸æŠ**
   æœˆæ¬¡è¨ˆç®—å‰ã« `incomeSource` ã§ã€Œå‰æœˆã€ã¾ãŸã¯ã€Œä»Šæœˆã€ã‚’æŒ‡å®šã€‚å‰æœˆãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆã¯ä»Šæœˆå›ºå®šã€‚

### 6.4 ç”»é¢é·ç§»å›³

```mermaid
stateDiagram
  [*] --> Splash
  Splash --> Login : æœªèªè¨¼
  Splash --> Books : èªè¨¼æ¸ˆã¿
  Login --> Books : ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
  Signup --> Books : ç™»éŒ²å®Œäº†
  Splash --> Signup : æ–°è¦ç™»éŒ²
  Books --> Home : å®¶è¨ˆç°¿é¸æŠ
  Books --> BookCreate : å®¶è¨ˆç°¿ä½œæˆ
  Home --> Entries : åæ”¯ç™»éŒ²
  Home --> Payees : æ”¯æ‰•å…ˆç™»éŒ²
  Home --> Calc : ç®—å‡ºè¨­å®š
  Home --> Basic : åŸºæœ¬è¨­å®š
  Home --> Users : ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
  Home --> Me : ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
  Entries --> Home
  Payees --> Home
  Calc --> Home
  Basic --> Home
  Users --> Home
  Me --> Home
```

## 7. å®Ÿè£…æ–¹é‡ï¼ˆAI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé‹ç”¨ï¼‰

1. **docs/specs** é…ä¸‹ã« YAML å½¢å¼ã§ _ä»•æ§˜ãƒ»è©³ç´°è¨­è¨ˆãƒ»ãƒ†ãƒƒã‚¯ã‚¹ã‚¿ãƒƒã‚¯ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ»DB å®šç¾©ãƒ»ãƒ†ã‚¹ãƒˆè¨ˆç”»_ ã‚’åˆ†é›¢ä¿å­˜ã™ã‚‹ã€‚
2. ã‚¿ã‚¹ã‚¯ã¯ **docs/tasks/pending** ã«ç²’åº¦æœ€å°ã§é…ç½®ã—ã€å®Œäº†å¾Œ **docs/tasks/done** ã¸ç§»å‹•ã€‚
3. ä¾å­˜é–¢ä¿‚ã¯ `task_manager.yaml` ã§ DAG ç®¡ç†ã—ã€ç›´åˆ—ï¼ä¸¦åˆ—ã‚’æ˜ç¤ºã€‚
4. å„ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã« AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å¿…ãšä¸Šè¨˜ YAML ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€çŸ›ç›¾ãŒç„¡ã„ã‹æ¤œè¨¼ã™ã‚‹ã€‚
5. ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¾Œã¯ **CI (GitHub Actions)** ã§ `pnpm test && playwright test --reporter=line` ã‚’é€šéã™ã‚‹ã¾ã§ã¯å®Œäº†ã¨ã—ãªã„ã€‚
6. **çœç•¥ç¦æ­¢ / ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚¼ãƒ­** ã‚’éµå®ˆã—ã€å¤‰æ›´å·®åˆ†ã¯æ˜ç¤ºçš„ã« Pull Request ã§å…±æœ‰ã™ã‚‹ã€‚

---

## 8. ãƒ‰ãƒ¡ã‚¤ãƒ³èªå½™é›†

| ç”¨èª           | è‹±èª        | å®šç¾©                                                           |
| -------------- | ----------- | -------------------------------------------------------------- |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼       | User        | ã‚¢ãƒ—ãƒªã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å€‹äººã€‚email, name, password ã‚’ä¿æŒ         |
| å®¶è¨ˆç°¿         | Book        | å…±åŒå®¶è¨ˆç°¿ã®å˜ä½ã€‚inviteCode ã§å‚åŠ è€…ã‚’æ‹›å¾…                    |
| å‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼   | BookUser    | User ã¨ Book ã®ä¸­é–“ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€‚role ã¨ approved ãƒ•ãƒ©ã‚°ã‚’æŒã¤ |
| æœˆæ¬¡åæ”¯       | Entry       | æœˆã”ã¨ã®åå…¥ãƒ»æ”¯å‡ºãƒ»å…±æœ‰åå…¥ãƒ»å…±æœ‰æ”¯å‡ºã‚’ä¿æŒã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰       |
| æ”¯æ‰•å…ˆ         | Payee       | å®¶è¨ˆç°¿ã«ç´ã¥ãè«‹æ±‚å…ˆï¼ˆä¾‹: æ¥½å¤©ã€å®¶è³ƒï¼‰                         |
| æ”¯æ‰•é¡ç®—å‡ºè¨­å®š | CalcSetting | æ”¯æ‰•é¡ç®—å‡ºæ–¹å¼ã€ç«¯æ•°å‡¦ç†ãªã©ã®è¨­å®š                             |
| æ”¯æ‰•ç‡         | PayRatio    | å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ”¯æ‰•è² æ‹…ç‡ (åˆè¨ˆ100%)                              |

> æœ¬èªå½™é›†ã¯ UIï¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ã‚³ãƒ¼ãƒ‰è­˜åˆ¥å­ã§çµ±ä¸€çš„ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚

---

> æœ¬ README ã¯ 2024-06-XX ã«å…¨é¢æ”¹è¨‚ã•ã‚Œã¾ã—ãŸã€‚ä»¥å‰ã®å†…å®¹ã¯ Git å±¥æ­´ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## 9. Client / Server Component ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

Next.js 14 (App Router) ã§ã¯ **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼Server Component** ã§ã™ã€‚UI ã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå ´åˆã®ã¿ `"use client"` ã‚’å®£è¨€ã—ã¦ãã ã•ã„ã€‚

| å±¤                  | ä»£è¡¨ãƒ•ã‚¡ã‚¤ãƒ«ä¾‹                | ä½¿ãˆã‚‹ React API                        | import å…ˆåˆ¶ç´„                                                                                    | é…ç½®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª                          |
| ------------------- | ----------------------------- | --------------------------------------- | ------------------------------------------------------------------------------------------------ | ----------------------------------------- |
| Server Component    | `app/*.tsx` `app/(server)/**` | `use`ãƒ»`cache` ãªã© (å‰¯ä½œç”¨/çŠ¶æ…‹ NG)    | ã©ã“ã§ã‚‚å¯                                                                                       | `apps/web/src/app`                        |
| Client Component    | `"use client"` ä»˜ã `.tsx`    | `useState` `useEffect` `useAuth()` ãªã© | **Server Component ã‹ã‚‰ç›´æ¥ import ã—ãªã„**<br>å¿…è¦ãªã‚‰ `dynamic(() => import(), { ssr:false })` | `app/(client)/**`, `components/client/**` |
| Shared UI (no hook) | `packages/ui`                 | React 17 äº’æ› API                       | Client/Server åŒæ–¹ã‹ã‚‰ importå¯                                                                  | `packages/ui`                             |

### Auth ç³»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé…ç½®ãƒ«ãƒ¼ãƒ«

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ / ãƒ•ãƒƒã‚¯  | ç¨®åˆ¥             | é…ç½®                   | ä½¿ç”¨ä¸Šã®æ³¨æ„                                                                 |
| ------------------------ | ---------------- | ---------------------- | ---------------------------------------------------------------------------- |
| `useAuth`                | Client Hook      | `src/hooks/useAuth.ts` | èªè¨¼çŠ¶æ…‹ã‚¹ãƒˆã‚¢ï¼‹Supabase SDKã€‚Server ã§ã¯å‘¼ã°ãªã„                            |
| `AuthStateChecker`       | Client Component | `src/components/auth`  | ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã§ **å‹•çš„ import (ssr:false)** ã—ã¦é·ç§»åˆ¶å¾¡ã‚’è¡Œã†                |
| `LoginForm` `SignupForm` | Client Component | `src/components/auth`  | è¦ªãƒšãƒ¼ã‚¸ã‚‚ `"use client"` ã‚’ä»˜ä¸ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ãƒšãƒ¼ã‚¸å†…éƒ¨ã«é–‰ã˜è¾¼ã‚ã‚‹ |
| èªè¨¼ã‚¬ãƒ¼ãƒ‰ä»˜ããƒšãƒ¼ã‚¸     | Client Page      | ä¾‹:`/login/page.tsx`   | `"use client"` ã‚’å®£è¨€ã€‚getServerSideProps ç­‰ã¯æœªä½¿ç”¨                         |

> **é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹**
>
> ```txt
> src/app/login/page.tsx     â† "use client" ä»˜ããƒšãƒ¼ã‚¸ (Form ã‚¤ãƒ™ãƒ³ãƒˆç”¨)
> src/components/auth/LoginForm.tsx (Client)
> src/components/AuthStateChecker.tsx (Client) â† layout ã§ã¯ dynamic import
> ```

ã“ã‚Œã«ã‚ˆã‚Šã€**Server â‡„ Client** ã®å¢ƒç•Œã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸å¯èƒ½ãªå€¤ï¼ˆé–¢æ•°ãƒ»Class ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰ãŒæµã‚Œãšã€`Event handlers cannot be passed to Client Component props` ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã’ã¾ã™ã€‚
