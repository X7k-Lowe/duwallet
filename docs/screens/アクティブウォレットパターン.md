# アクティブウォレットパターン実装ガイド

## 概要

アクティブウォレットパターンは、URL からID (UUID) を省略し、代わりに「現在選択中の家計簿」という概念を導入する実装アプローチです。ユーザーは一度に1つの家計簿のみを操作するため、複数の家計簿を持っていても、常に「アクティブな」家計簿に対して操作を行います。

### メリット

- シンプルで読みやすいURL（`/wallet/expenses`など）
- 家計簿IDがURLに露出しないためセキュリティ向上
- 実装がシンプルになる
- ユーザー体験の一貫性が高まる

### デメリット

- 同時に複数の家計簿を操作できない
- ブックマークが特定の家計簿に紐づかない

## ホーム画面の実装

家計簿ホーム画面（S-05_wallet_home.yaml）は、アクティブウォレットパターンにおいて重要な役割を果たします。
この画面は以下の特徴を持ちます：

- `/wallet` パスで直接アクセス可能
- 現在選択中の家計簿の概要情報を表示
- 月次の収支サマリーや支払期限などの主要情報を集約
- サイドバーメニューから全機能へのアクセスポイントとして機能

## ディレクトリと URL 構造

具体的なディレクトリ構造については、[ディレクトリ構成.md](./ディレクトリ構成.md) を参照してください。

このアプローチでは、以下のような URL 構造を採用します：

- `/login` - ログイン画面
- `/register` - ユーザー登録画面
- `/wallet/select` - 家計簿選択画面
- `/wallet/create` - 家計簿作成画面
- `/wallet` - 家計簿ホーム画面（アクティブな家計簿）
- `/wallet/expenses` - 収支登録画面（アクティブな家計簿）
- `/wallet/payments` - 支払先登録画面（アクティブな家計簿）
- `/wallet/calculations` - 支払額算出設定画面（アクティブな家計簿）
- `/wallet/settings` - 基本設定編集画面（アクティブな家計簿）
- `/wallet/members` - 参加ユーザー管理画面（アクティブな家計簿）
- `/user/settings` - ユーザー設定画面

## 状態管理の実装

### アクティブウォレットストア

```typescript
// stores/wallet-store.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';

interface WalletState {
  activeWalletId: string | null;
  activeWalletName: string | null;
  wallets: { id: string; name: string }[];
  setActiveWallet: (id: string, name: string) => void;
  loadWallets: () => Promise<void>;
  isLoading: boolean;
}

export const useWalletStore = create<WalletState>()(
  persist(
    (set, get) => ({
      activeWalletId: null,
      activeWalletName: null,
      wallets: [],
      isLoading: false,
      
      setActiveWallet: (id, name) => set({ 
        activeWalletId: id, 
        activeWalletName: name 
      }),
      
      loadWallets: async () => {
        const supabase = createClientComponentClient();
        set({ isLoading: true });
        
        try {
          // ログインユーザーが参加している家計簿一覧を取得
          const { data: { user } } = await supabase.auth.getUser();
          
          if (!user) {
            set({ wallets: [], isLoading: false });
            return;
          }
          
          const { data, error } = await supabase
            .from('wallet_members')
            .select(`
              wallet_id,
              wallets (
                id,
                name
              )
            `)
            .eq('user_id', user.id);
            
          if (error) throw error;
          
          const walletList = data.map(item => ({
            id: item.wallets.id,
            name: item.wallets.name
          }));
          
          set({ wallets: walletList, isLoading: false });
          
          // まだアクティブな家計簿がなく、家計簿が1つのみの場合、自動的に設定
          const { activeWalletId } = get();
          if (!activeWalletId && walletList.length === 1) {
            set({
              activeWalletId: walletList[0].id,
              activeWalletName: walletList[0].name
            });
          }
        } catch (error) {
          console.error('家計簿一覧の取得に失敗しました', error);
          set({ isLoading: false });
        }
      }
    }),
    {
      name: 'wallet-storage'
    }
  )
);
```

### ユーザー設定ストア

```typescript
// stores/user-settings-store.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface UserSettingsState {
  isMultiWalletEnabled: boolean;
  setMultiWalletEnabled: (enabled: boolean) => void;
}

export const useUserSettingsStore = create<UserSettingsState>()(
  persist(
    (set) => ({
      isMultiWalletEnabled: true, // デフォルトで複数家計簿参加可能
      setMultiWalletEnabled: (enabled) => set({ isMultiWalletEnabled: enabled })
    }),
    {
      name: 'user-settings'
    }
  )
);
```

## ミドルウェアによる自動遷移ロジック実装

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });
  const { data: { session } } = await supabase.auth.getSession();
  
  // URLパスを取得
  const path = req.nextUrl.pathname;
  
  // 1. ログイン済みでない場合：タイトル画面（S-01）を表示
  if (!session) {
    // 認証が必要なページへのアクセスをログイン画面にリダイレクト
    if (
      !path.startsWith('/login') && 
      !path.startsWith('/register') && 
      !path.startsWith('/_next') &&
      !path.startsWith('/api')
    ) {
      return NextResponse.redirect(new URL('/login', req.url));
    }
    return res;
  }
  
  // ログイン済みの場合は、認証画面へのアクセスを適切にリダイレクト
  if (path === '/login' || path === '/register' || path === '/') {
    // ユーザー設定の取得
    const userSettingsCookie = req.cookies.get('user-settings');
    let isMultiWalletEnabled = true; // デフォルト: 複数家計簿参加可能
    
    if (userSettingsCookie) {
      try {
        const parsedValue = JSON.parse(userSettingsCookie.value);
        isMultiWalletEnabled = parsedValue.state?.isMultiWalletEnabled ?? true;
      } catch (e) {
        console.error('Invalid user settings cookie', e);
      }
    }
    
    // 家計簿情報の取得
    const walletStorageCookie = req.cookies.get('wallet-storage');
    let activeWalletId = null;
    let wallets = [];
    
    if (walletStorageCookie) {
      try {
        const parsedValue = JSON.parse(walletStorageCookie.value);
        activeWalletId = parsedValue.state?.activeWalletId;
        wallets = parsedValue.state?.wallets || [];
      } catch (e) {
        console.error('Invalid wallet storage cookie', e);
      }
    }
    
    // 2. ログイン済みで、参加中の家計簿がない場合：家計簿選択画面（S-03）に遷移
    if (wallets.length === 0) {
      return NextResponse.redirect(new URL('/wallet/select', req.url));
    }
    
    // 3. ログイン済みで、参加中の家計簿があり、複数家計簿に参加する設定の場合：家計簿選択画面（S-03）に遷移
    if (isMultiWalletEnabled) {
      return NextResponse.redirect(new URL('/wallet/select', req.url));
    }
    
    // 4. ログイン済みで、参加中の家計簿があり、一つの家計簿のみに参加する設定の場合：家計簿ホーム画面（S-05）に直接遷移
    return NextResponse.redirect(new URL('/wallet', req.url));
  }
  
  // アクティブウォレットが必要なページへのアクセス時、選択中の家計簿がなければ選択画面へ
  if (
    path.startsWith('/wallet') && 
    path !== '/wallet/select' && 
    path !== '/wallet/create'
  ) {
    const walletStorageCookie = req.cookies.get('wallet-storage');
    let activeWalletId = null;
    
    if (walletStorageCookie) {
      try {
        const parsedValue = JSON.parse(walletStorageCookie.value);
        activeWalletId = parsedValue.state?.activeWalletId;
      } catch (e) {
        console.error('Invalid wallet storage cookie', e);
      }
    }
    
    if (!activeWalletId) {
      return NextResponse.redirect(new URL('/wallet/select', req.url));
    }
  }
  
  return res;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
};
```

## 家計簿選択画面の実装

```typescript
// app/(wallet)/select/page.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useWalletStore } from '@/stores/wallet-store';
import { useUserSettingsStore } from '@/stores/user-settings-store';
import { Button, Card, Spinner } from '@/components/ui';

export default function WalletSelectPage() {
  const router = useRouter();
  const { 
    wallets, 
    loadWallets, 
    setActiveWallet, 
    isLoading 
  } = useWalletStore();
  
  const { 
    isMultiWalletEnabled 
  } = useUserSettingsStore();
  
  useEffect(() => {
    loadWallets();
  }, [loadWallets]);
  
  const handleSelectWallet = (id: string, name: string) => {
    setActiveWallet(id, name);
    
    // 家計簿を選択したら家計簿ホーム画面へ遷移
    router.push('/wallet');
  };
  
  const handleCreateWallet = () => {
    router.push('/wallet/create');
  };
  
  const handleUserSettings = () => {
    router.push('/user/settings');
  };
  
  // 一つの家計簿のみ参加設定で、自動選択できる場合
  useEffect(() => {
    if (!isMultiWalletEnabled && wallets.length === 1) {
      handleSelectWallet(wallets[0].id, wallets[0].name);
    }
  }, [wallets, isMultiWalletEnabled]);
  
  if (isLoading) {
    return <Spinner />;
  }
  
  return (
    <div className="container mx-auto p-4">
      <h1 className="text-2xl font-bold mb-6">家計簿を選択</h1>
      
      {wallets.length === 0 ? (
        <p className="mb-4">参加中の家計簿はありません。新しく作成するか、既存の家計簿に参加してください。</p>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {wallets.map((wallet) => (
            <Card 
              key={wallet.id}
              className="p-4 cursor-pointer hover:shadow-md transition-shadow"
              onClick={() => handleSelectWallet(wallet.id, wallet.name)}
            >
              <h2 className="font-semibold text-lg">{wallet.name}</h2>
            </Card>
          ))}
        </div>
      )}
      
      <div className="mt-6 flex gap-4">
        <Button onClick={handleCreateWallet}>
          新しい家計簿を作成
        </Button>
        
        <Button variant="outline" onClick={handleUserSettings}>
          ユーザー設定
        </Button>
      </div>
    </div>
  );
}
```

## アクティブウォレット情報の利用

```typescript
// app/(wallet)/layout.tsx
'use client';

import { useEffect } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { useWalletStore } from '@/stores/wallet-store';
import { Header, Sidebar } from '@/components/layouts';

export default function WalletLayout({ children }) {
  const { 
    activeWalletId, 
    activeWalletName,
    loadWallets 
  } = useWalletStore();
  
  const router = useRouter();
  const pathname = usePathname();
  
  useEffect(() => {
    // 選択画面と作成画面を除く他のウォレット関連ページでは
    // アクティブウォレットが必要
    if (
      pathname !== '/wallet/select' && 
      pathname !== '/wallet/create' && 
      !activeWalletId
    ) {
      router.push('/wallet/select');
    }
    
    // コンポーネントマウント時に家計簿一覧を更新
    loadWallets();
  }, [pathname, activeWalletId, router, loadWallets]);
  
  const isSelectOrCreatePage = 
    pathname === '/wallet/select' || 
    pathname === '/wallet/create';
  
  return (
    <div className="flex min-h-screen">
      {!isSelectOrCreatePage && activeWalletId && (
        <Sidebar activeWalletId={activeWalletId} />
      )}
      
      <div className="flex-1">
        {!isSelectOrCreatePage && activeWalletId && (
          <Header walletName={activeWalletName || '家計簿'} />
        )}
        
        <main className="p-4">
          {children}
        </main>
      </div>
    </div>
  );
}
```

## データ取得時のアクティブウォレットID利用

```typescript
// hooks/use-income-expenses.ts
import { useState, useEffect } from 'react';
import { useWalletStore } from '@/stores/wallet-store';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import type { IncomeExpense } from '@/types/income-expense';

export function useIncomeExpenses(year: number, month: number) {
  const { activeWalletId } = useWalletStore();
  const [data, setData] = useState<IncomeExpense[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<Error | null>(null);
  
  const supabase = createClientComponentClient();
  
  useEffect(() => {
    if (!activeWalletId) return;
    
    const fetchData = async () => {
      setIsLoading(true);
      setError(null);
      
      try {
        // 選択中の家計簿の収支データを取得
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0);
        
        const { data, error } = await supabase
          .from('income_expenses')
          .select('*')
          .eq('wallet_id', activeWalletId)
          .gte('date', startDate.toISOString())
          .lte('date', endDate.toISOString());
          
        if (error) throw error;
        
        setData(data || []);
      } catch (err) {
        setError(err instanceof Error ? err : new Error(String(err)));
      } finally {
        setIsLoading(false);
      }
    };
    
    fetchData();
  }, [activeWalletId, year, month, supabase]);
  
  return { data, isLoading, error };
}
```

## PWA対応の考慮点

```typescript
// app/layout.tsx
'use client';

import { useEffect } from 'react';
import { useWalletStore } from '@/stores/wallet-store';
import { useUserSettingsStore } from '@/stores/user-settings-store';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';

export default function RootLayout({ children }) {
  const { loadWallets } = useWalletStore();
  
  useEffect(() => {
    // PWA起動時の状態復元処理
    const handleAppStart = async () => {
      const supabase = createClientComponentClient();
      const { data } = await supabase.auth.getSession();
      
      if (data.session) {
        // ログイン済みの場合は家計簿一覧を更新
        loadWallets();
      }
    };
    
    // visibilitychange イベントでPWAのバックグラウンド復帰を検知
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        handleAppStart();
      }
    });
    
    // 初回実行
    handleAppStart();
    
    return () => {
      document.removeEventListener('visibilitychange', handleAppStart);
    };
  }, [loadWallets]);
  
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  );
}
```

## セキュリティ考慮点

1. **Row Level Security (RLS) の実装**

```sql
-- wallets テーブルのRLSポリシー
CREATE POLICY "参加者のみ家計簿にアクセス可能"
  ON wallets
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM wallet_members 
      WHERE wallet_members.wallet_id = wallets.id 
      AND wallet_members.user_id = auth.uid()
    )
  );

-- 同様に他のテーブルにも参照元の wallet_id に基づいてRLSを設定
```

2. **Server Actionsでのバリデーション**

```typescript
// app/(wallet)/expenses/actions.ts
'use server';

import { createServerActionClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { z } from 'zod';
import { revalidatePath } from 'next/cache';

// バリデーションスキーマ
const expenseSchema = z.object({
  walletId: z.string().uuid(),
  amount: z.number().positive(),
  // 他のフィールド
});

export async function addExpense(formData: FormData) {
  const supabase = createServerActionClient({ cookies });
  
  // ログインチェック
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    return { error: 'Unauthorized' };
  }
  
  // walletIdを取得（クライアントストアから送信されたもの）
  const walletId = formData.get('walletId') as string;
  
  // このユーザーが本当にこの家計簿に参加しているか確認
  const { data: memberCheck } = await supabase
    .from('wallet_members')
    .select('id')
    .eq('wallet_id', walletId)
    .eq('user_id', session.user.id)
    .single();
    
  if (!memberCheck) {
    return { error: 'この家計簿にアクセスする権限がありません' };
  }
  
  // 以降、通常の処理
  try {
    // バリデーション
    const validData = expenseSchema.parse({
      walletId,
      amount: Number(formData.get('amount')),
      // 他のフィールド
    });
    
    // DB登録
    const { data, error } = await supabase
      .from('income_expenses')
      .insert([{
        wallet_id: validData.walletId,
        amount: validData.amount,
        // 他のフィールド
      }]);
      
    if (error) throw error;
    
    // キャッシュの更新
    revalidatePath('/wallet/expenses');
    
    return { success: true };
  } catch (error) {
    return { 
      error: error instanceof Error ? error.message : '不明なエラーが発生しました' 
    };
  }
}
```

## まとめ

アクティブウォレットパターンの利点は、URLから複雑なIDを排除しながらも、一貫したユーザー体験を提供できる点です。同時に複数の家計簿を操作することはできませんが、ほとんどのユーザーにとってこれは問題にならないでしょう。

ミドルウェアとフロントエンドの状態管理を組み合わせることで、URLを単純化しながらも、画面一覧.mdで定義された起動時自動遷移ロジックを実現できます。また、Supabaseのセキュリティ機能と組み合わせることで、安全かつ使いやすいアプリケーションを構築できます。

PWAとしてホーム画面に追加した場合も、適切な状態管理と復元ロジックにより、シームレスなユーザー体験を提供できます。 